<form class="space-y-4 p-4" [formGroup]="form" (ngSubmit)="save()">
  <!-- DateTime Picker Section -->
  <section class="rounded-3xl bg-surface p-4 shadow-brand-soft space-y-3">
    <header class="flex items-center justify-between">
      <p class="text-sm font-semibold text-ink">{{ 'record.when' | translate }}</p>
      <span class="text-xs text-muted">{{ 'record.setMeasurementTime' | translate }}</span>
    </header>
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="text-xs text-muted block mb-1">{{ 'record.date' | translate }}</label>
        <input type="date" formControlName="date" class="input w-full">
      </div>
      <div>
        <label class="text-xs text-muted block mb-1">{{ 'record.time' | translate }}</label>
        <input type="time" formControlName="time" class="input w-full">
      </div>
    </div>
  </section>

  <!-- BP Section (Collapsible) -->
  <section class="rounded-3xl bg-surface shadow-brand-soft overflow-hidden">
    <header 
      class="flex items-center justify-between p-4 cursor-pointer hover:bg-surface-muted/30 transition-colors"
      (click)="toggleSection('bp')">
      <div class="flex items-center gap-2">
        <span class="text-2xl">üíì</span>
        <p class="text-sm font-semibold text-ink">{{ 'record.bloodPressure' | translate }}</p>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-muted" *ngIf="form.get('bp.sys')?.value && form.get('bp.dia')?.value">
          {{ form.get('bp.sys')?.value }}/{{ form.get('bp.dia')?.value }}
        </span>
        <svg class="w-5 h-5 transition-transform" [class.rotate-180]="isSectionExpanded('bp')" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </header>
    <div class="p-4 pt-0 space-y-3" *ngIf="isSectionExpanded('bp')" formGroupName="bp">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-muted block mb-1">{{ 'record.systolic' | translate }}</label>
          <input type="number" formControlName="sys" class="input" placeholder="120">
        </div>
        <div>
          <label class="text-xs text-muted block mb-1">{{ 'record.diastolic' | translate }}</label>
          <input type="number" formControlName="dia" class="input" placeholder="80">
        </div>
      </div>
      <p class="text-xs text-muted">{{ 'record.normalBP' | translate }}</p>
    </div>
  </section>

  <!-- Glucose Section (Collapsible) -->
  <section class="rounded-3xl bg-surface shadow-brand-soft overflow-hidden">
    <header 
      class="flex items-center justify-between p-4 cursor-pointer hover:bg-surface-muted/30 transition-colors"
      (click)="toggleSection('glucose')">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ü©∏</span>
        <p class="text-sm font-semibold text-ink">{{ 'record.bloodGlucose' | translate }}</p>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-muted" *ngIf="form.get('glucose.mmol')?.value">
          {{ form.get('glucose.mmol')?.value }} mmol/L
        </span>
        <svg class="w-5 h-5 transition-transform" [class.rotate-180]="isSectionExpanded('glucose')" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </header>
    <div class="p-4 pt-0 space-y-3" *ngIf="isSectionExpanded('glucose')" formGroupName="glucose">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-muted block mb-1">{{ 'record.level' | translate }}</label>
          <input type="number" step="0.1" formControlName="mmol" class="input" placeholder="5.5">
        </div>
        <div>
          <label class="text-xs text-muted block mb-1">{{ 'record.context' | translate }}</label>
          <select formControlName="context" class="input">
            <option value="fasting">{{ 'record.fasting' | translate }}</option>
            <option value="random">{{ 'record.random' | translate }}</option>
          </select>
        </div>
      </div>
      <p class="text-xs text-muted">{{ 'record.normalGlucose' | translate }}</p>
    </div>
  </section>

  <!-- Weight & Height Section (Collapsible) -->
  <section class="rounded-3xl bg-surface shadow-brand-soft overflow-hidden">
    <header 
      class="flex items-center justify-between p-4 cursor-pointer hover:bg-surface-muted/30 transition-colors"
      (click)="toggleSection('weightHeight')">
      <div class="flex items-center gap-2">
        <span class="text-2xl">‚öñÔ∏è</span>
        <p class="text-sm font-semibold text-ink">{{ 'record.weightHeight' | translate }}</p>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-muted" *ngIf="calculateBMI()">
          BMI: {{ calculateBMI() }} ({{ 'record.' + getBMICategory(calculateBMI()!) | translate }})
        </span>
        <svg class="w-5 h-5 transition-transform" [class.rotate-180]="isSectionExpanded('weightHeight')" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </header>
    <div class="p-4 pt-0 space-y-3" *ngIf="isSectionExpanded('weightHeight')">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-muted block mb-1">{{ 'record.weight' | translate }} ({{ 'record.kg' | translate }})</label>
          <input 
            type="number" 
            step="0.1" 
            formControlName="weight" 
            class="input" 
            [placeholder]="'record.weightPlaceholder' | translate"
            (input)="form.updateValueAndValidity()">
        </div>
        <div>
          <label class="text-xs text-muted block mb-1">{{ 'record.height' | translate }} ({{ 'record.cm' | translate }})</label>
          <input 
            type="number" 
            step="0.1" 
            formControlName="height" 
            class="input" 
            [placeholder]="'record.heightPlaceholder' | translate"
            (input)="form.updateValueAndValidity()">
        </div>
      </div>
      <div *ngIf="calculateBMI()" class="p-3 rounded-xl" 
           [class.bg-green-50]="getBMICategory(calculateBMI()!) === 'normal'"
           [class.bg-yellow-50]="getBMICategory(calculateBMI()!) === 'underweight' || getBMICategory(calculateBMI()!) === 'overweight'"
           [class.bg-orange-50]="getBMICategory(calculateBMI()!) === 'obese'"
           [class.border-green-200]="getBMICategory(calculateBMI()!) === 'normal'"
           [class.border-yellow-200]="getBMICategory(calculateBMI()!) === 'underweight' || getBMICategory(calculateBMI()!) === 'overweight'"
           [class.border-orange-200]="getBMICategory(calculateBMI()!) === 'obese'"
           [class.border]="true">
        <p class="text-sm font-semibold text-ink">
          {{ 'record.bmi' | translate }}: <span class="text-lg">{{ calculateBMI() }}</span>
        </p>
        <p class="text-xs text-muted mt-1">
          {{ 'record.bmiCategory' | translate }}: {{ 'record.' + getBMICategory(calculateBMI()!) | translate }}
        </p>
      </div>
      <p class="text-xs text-muted">{{ 'record.bmiInfo' | translate }}</p>
    </div>
  </section>

  <!-- Medications Section (Collapsible) -->
  <section class="rounded-3xl bg-surface shadow-brand-soft overflow-hidden">
    <header 
      class="flex items-center justify-between p-4 cursor-pointer hover:bg-surface-muted/30 transition-colors"
      (click)="toggleSection('meds')">
      <div class="flex items-center gap-2">
        <span class="text-2xl">üíä</span>
        <p class="text-sm font-semibold text-ink">{{ 'record.medications' | translate }}</p>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-muted" *ngIf="selectedMeds().length > 0">
          {{ selectedMeds().length }} {{ selectedMeds().length === 1 ? ('record.med' | translate) : ('record.meds' | translate) }}
        </span>
        <svg class="w-5 h-5 transition-transform" [class.rotate-180]="isSectionExpanded('meds')" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </header>
    <div class="p-4 pt-0 space-y-3" *ngIf="isSectionExpanded('meds')">
      <!-- Taken checkbox -->
      <label class="flex items-center gap-2 p-3 bg-surface-muted/30 rounded-xl">
        <input type="checkbox" formControlName="medsTaken" class="checkbox">
        <span class="text-sm font-medium">{{ 'record.tookMedications' | translate }}</span>
      </label>

      <!-- Selected medications (tags) -->
      <div *ngIf="selectedMeds().length > 0" class="space-y-2 p-3 bg-green-50 rounded-xl border border-green-200">
        <p class="text-xs text-muted uppercase tracking-wider">{{ 'record.selectedMedications' | translate }}</p>
        <div class="space-y-2">
          <div 
            *ngFor="let med of selectedMeds()" 
            class="flex items-center justify-between gap-3 p-3 bg-white rounded-xl border border-green-300 shadow-sm">
            <span class="font-medium text-ink flex-1">{{ med }}</span>
            <button 
              type="button" 
              (click)="removeMed(med)" 
              class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 font-bold text-xl transition-colors"
              [title]="('record.remove' | translate) + ' ' + med">
              √ó
            </button>
          </div>
        </div>
      </div>

      <!-- Add medication with autocomplete -->
      <div class="space-y-2">
        <p class="text-xs text-muted uppercase tracking-wider">{{ 'record.addMedication' | translate }}</p>
        <div class="space-y-2 relative">
          <input 
            type="text" 
            [value]="newMedInput()"
            (input)="newMedInput.set($any($event.target).value)"
            (keyup.enter)="addMed(newMedInput())"
            class="input w-full text-base" 
            [placeholder]="'record.startTypingMedication' | translate"
            autocomplete="off">
          
          <!-- Autocomplete suggestions (appear after 2 characters) -->
          <div *ngIf="medSuggestions().length > 0" class="absolute z-10 w-full bg-white border-2 border-brand rounded-xl shadow-lg overflow-hidden">
            <button 
              *ngFor="let med of medSuggestions()" 
              type="button"
              (click)="selectMedFromSuggestion(med)"
              class="w-full flex items-center gap-2 p-3 hover:bg-brand/10 text-left border-b border-border last:border-b-0 transition-colors active:bg-brand/20">
              <span class="text-brand font-bold text-lg">‚Üí</span>
              <span class="font-medium text-ink">{{ med }}</span>
            </button>
          </div>
          
          <button 
            type="button"
            (click)="addMed(newMedInput())"
            [disabled]="!newMedInput().trim()"
            class="pill-button w-full text-base py-3"
            [class.opacity-50]="!newMedInput().trim()">
            {{ 'record.addMedicationButton' | translate }}
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Food Section (Collapsible) -->
  <section class="rounded-3xl bg-surface shadow-brand-soft overflow-hidden">
    <header 
      class="flex items-center justify-between p-4 cursor-pointer hover:bg-surface-muted/30 transition-colors"
      (click)="toggleSection('food')">
      <div class="flex items-center gap-2">
        <span class="text-2xl">üçΩÔ∏è</span>
        <p class="text-sm font-semibold text-ink">{{ 'record.foodAndDiet' | translate }}</p>
      </div>
      <svg class="w-5 h-5 transition-transform" [class.rotate-180]="isSectionExpanded('food')" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </header>
    <div class="p-4 pt-0 space-y-3" *ngIf="isSectionExpanded('food')" formGroupName="food">
      <div class="flex gap-4">
        <label class="flex-1 text-center">
          <span class="text-xs text-muted block mb-2">{{ 'record.saltIntake' | translate }}</span>
          <input type="range" min="1" max="5" formControlName="salt" class="w-full">
          <span class="text-xs text-muted">{{ form.get('food.salt')?.value }}/5</span>
        </label>
        <label class="flex-1 text-center">
          <span class="text-xs text-muted block mb-2">{{ 'record.carbIntake' | translate }}</span>
          <input type="range" min="1" max="5" formControlName="carb" class="w-full">
          <span class="text-xs text-muted">{{ form.get('food.carb')?.value }}/5</span>
        </label>
      </div>
      <textarea rows="2" formControlName="notes" class="input" [placeholder]="'record.whatDidYouEat' | translate"></textarea>
    </div>
  </section>

  <!-- Lifestyle Section (Collapsible) -->
  <section class="rounded-3xl bg-surface shadow-brand-soft overflow-hidden">
    <header 
      class="flex items-center justify-between p-4 cursor-pointer hover:bg-surface-muted/30 transition-colors"
      (click)="toggleSection('lifestyle')">
      <div class="flex items-center gap-2">
        <span class="text-2xl">üèÉ</span>
        <p class="text-sm font-semibold text-ink">{{ 'record.lifestyle' | translate }}</p>
      </div>
      <svg class="w-5 h-5 transition-transform" [class.rotate-180]="isSectionExpanded('lifestyle')" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </header>
    <div class="p-4 pt-0 space-y-4" *ngIf="isSectionExpanded('lifestyle')">
      <div class="grid grid-cols-2 gap-3">
        <div formGroupName="exercise">
          <label class="text-xs text-muted block mb-1">{{ 'record.exerciseMinutes' | translate }}</label>
          <input type="number" formControlName="minutes" class="input" placeholder="30">
        </div>
        <div>
          <label class="text-xs text-muted block mb-1">{{ 'record.alcohol' | translate }}</label>
          <input type="number" formControlName="alcohol" class="input" placeholder="0">
        </div>
        <div class="col-span-2">
          <label class="text-xs text-muted block mb-1">{{ 'record.cigarettes' | translate }}</label>
          <input type="number" formControlName="cigarettes" class="input" placeholder="0">
        </div>
      </div>

      <!-- Herbs Section -->
      <div class="space-y-3 pt-3 border-t border-border/30">
        <div class="flex items-center gap-2">
          <span class="text-lg">üåø</span>
          <p class="text-sm font-semibold text-ink">{{ 'record.herbalSupplements' | translate }}</p>
          <span class="text-xs text-muted" *ngIf="selectedHerbs().length > 0">
            ({{ selectedHerbs().length }})
          </span>
        </div>

        <!-- Selected herbs (tags) -->
        <div *ngIf="selectedHerbs().length > 0" class="space-y-2 p-3 bg-green-50 rounded-xl border border-green-200">
          <p class="text-xs text-muted uppercase tracking-wider">{{ 'record.selectedHerbs' | translate }}</p>
          <div class="space-y-2">
            <div 
              *ngFor="let herb of selectedHerbs()" 
              class="flex items-center justify-between gap-3 p-3 bg-white rounded-xl border border-green-300 shadow-sm">
              <span class="font-medium text-ink flex-1">{{ herb }}</span>
              <button 
                type="button" 
                (click)="removeHerb(herb)" 
                class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 font-bold text-xl transition-colors"
                [title]="('record.remove' | translate) + ' ' + herb">
                √ó
              </button>
            </div>
          </div>
        </div>

        <!-- Add herb with autocomplete -->
        <div class="space-y-2">
          <p class="text-xs text-muted uppercase tracking-wider">{{ 'record.addHerb' | translate }}</p>
          <div class="space-y-2 relative">
            <input 
              type="text" 
              [value]="newHerbInput()"
              (input)="newHerbInput.set($any($event.target).value)"
              (keyup.enter)="addHerb(newHerbInput())"
              class="input w-full text-base" 
              [placeholder]="'record.startTypingHerb' | translate"
              autocomplete="off">
            
            <!-- Autocomplete suggestions (appear after 2 characters) -->
            <div *ngIf="herbSuggestions().length > 0" class="absolute z-10 w-full bg-white border-2 border-brand rounded-xl shadow-lg overflow-hidden">
              <button 
                *ngFor="let herb of herbSuggestions()" 
                type="button"
                (click)="selectHerbFromSuggestion(herb)"
                class="w-full flex items-center gap-2 p-3 hover:bg-brand/10 text-left border-b border-border last:border-b-0 transition-colors active:bg-brand/20">
                <span class="text-brand font-bold text-lg">‚Üí</span>
                <span class="font-medium text-ink">{{ herb }}</span>
              </button>
            </div>
            
            <button 
              type="button"
              (click)="addHerb(newHerbInput())"
              [disabled]="!newHerbInput().trim()"
              class="pill-button w-full text-base py-3"
              [class.opacity-50]="!newHerbInput().trim()">
              {{ 'record.addHerbButton' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- General Notes Section (Always Visible) -->
  <section class="rounded-3xl bg-surface p-4 shadow-brand-soft">
    <label class="text-xs text-muted block mb-2">{{ 'record.additionalNotes' | translate }}</label>
    <textarea rows="3" formControlName="notes" class="input" [placeholder]="'record.anyOtherNotes' | translate"></textarea>
  </section>

  <!-- Action Buttons -->
  <div class="sticky bottom-4 space-y-2">
    <div class="grid grid-cols-2 gap-3">
      <button 
        type="button"
        (click)="cancel()"
        class="px-6 py-4 text-lg font-semibold rounded-2xl bg-surface border-2 border-border text-ink hover:bg-surface-muted/50 shadow-md hover:shadow-lg transition-all"
        [disabled]="status() === 'saving' || status() === 'success'">
        ‚Üê {{ 'common.cancel' | translate }}
      </button>
      <button 
        type="submit" 
        class="pill-button text-lg shadow-lg transition-all"
        [disabled]="status() === 'saving' || status() === 'success'"
        [class.opacity-50]="status() === 'saving'"
        [class.bg-green-600]="status() === 'success'">
        <span *ngIf="status() === 'idle' || status() === 'error'">üíæ {{ 'common.save' | translate }}</span>
        <span *ngIf="status() === 'saving'">‚è≥ {{ 'common.saving' | translate }}</span>
        <span *ngIf="status() === 'success'">‚úÖ {{ 'common.saved' | translate }}</span>
      </button>
    </div>
    <p class="text-center text-danger text-sm font-semibold" *ngIf="errorMessage()">
      ‚ùå {{ errorMessage() }}
    </p>
    <p class="text-center text-success text-sm font-semibold" *ngIf="status() === 'success'">
      {{ 'record.entrySavedSuccess' | translate }}
    </p>
    <p class="text-center text-xs text-muted" *ngIf="status() !== 'success'">
      {{ 'record.recordingAt' | translate }} {{ form.value.date | date:'short' }} {{ form.value.time }}
    </p>
  </div>
</form>
