<section *ngIf="profile(); else empty" class="space-y-4 p-4">
  <!-- View Mode -->
  <div *ngIf="!isEditMode()">
    <div class="flex items-center gap-3">
      <div class="w-16 h-16 rounded-2xl bg-brand-gradient flex items-center justify-center text-2xl text-white font-bold">
        {{ profile()?.displayName?.[0] || '?' }}
      </div>
      <div>
        <h2 class="text-xl font-semibold text-ink">{{ profile()?.displayName }}</h2>
        <p class="text-xs text-muted uppercase tracking-[0.4em]">{{ 'common.code' | translate }} {{ profile()?.shareCode || '••••' }}</p>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-2">
      <div class="stat-card">
        <p>{{ 'patient.birth' | translate }}</p>
        <h3>{{ profile()?.yearOfBirth || '—' }}</h3>
      </div>
      <div class="stat-card">
        <p>{{ 'auth.conditions' | translate }}</p>
        <h3>{{ profile()?.conditions?.length || 0 }}</h3>
      </div>
    </div>
    <div class="rounded-2xl bg-surface-muted/60 p-4 space-y-2">
      <div class="grid grid-cols-2 gap-2 text-sm text-muted">
        <span>{{ 'auth.phone' | translate }}</span>
        <span class="text-ink font-semibold">{{ profile()?.phone || '—' }}</span>
        <span>{{ 'auth.language' | translate }}</span>
        <span class="text-ink font-semibold">{{ profile()?.lang | uppercase }}</span>
      </div>
    </div>
    <div class="flex gap-2">
      <button *ngIf="canEdit()" type="button" class="pill-button flex-1 text-lg" (click)="startEdit()">
        {{ 'profile.edit' | translate }}
      </button>
      <button *ngIf="canLogout()" type="button" class="pill-button--danger flex-1 text-lg" (click)="logout()">
        {{ 'auth.logout' | translate }}
      </button>
    </div>
  </div>

  <!-- Edit Mode -->
  <form *ngIf="isEditMode()" [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="space-y-4">
    <div class="flex items-center gap-3">
      <div class="w-16 h-16 rounded-2xl bg-brand-gradient flex items-center justify-center text-2xl text-white font-bold">
        {{ profileForm.get('displayName')?.value?.[0] || '?' }}
      </div>
      <div class="flex-1">
        <h2 class="text-xl font-semibold text-ink">{{ 'profile.editProfile' | translate }}</h2>
        <p class="text-xs text-muted uppercase tracking-[0.4em]">{{ 'common.code' | translate }} {{ profile()?.shareCode || '••••' }}</p>
      </div>
    </div>

    <label class="field">
      <span>{{ 'auth.displayName' | translate }}</span>
      <input formControlName="displayName" type="text" class="input" [class.border-red-500]="profileForm.get('displayName')?.invalid && profileForm.get('displayName')?.touched" [class.ring-red-500]="profileForm.get('displayName')?.invalid && profileForm.get('displayName')?.touched">
      <span *ngIf="profileForm.get('displayName')?.invalid && profileForm.get('displayName')?.touched" class="text-xs text-red-500">
        {{ 'profile.displayNameRequired' | translate }}
      </span>
    </label>

    <label class="field">
      <span>{{ 'auth.phone' | translate }}</span>
      <input formControlName="phone" type="tel" class="input" placeholder="+255...">
    </label>

    <label class="field">
      <span>{{ 'auth.language' | translate }}</span>
      <select formControlName="lang" class="input">
        <option value="en">{{ 'languages.en' | translate }}</option>
        <option value="sw">{{ 'languages.sw' | translate }}</option>
      </select>
    </label>

    <label class="field">
      <span>{{ 'auth.yearOfBirth' | translate }}</span>
      <input formControlName="yearOfBirth" type="number" min="1930" max="2020" class="input">
    </label>

    <div class="rounded-2xl border border-border/70 p-3 space-y-2 text-sm" formGroupName="conditions">
      <span class="text-xs uppercase tracking-wide text-muted">{{ 'auth.conditions' | translate }}</span>
      <div class="flex gap-4">
        <label class="chip">
          <input type="checkbox" formControlName="hypertension" class="checkbox">
          {{ 'conditions.hypertension' | translate }}
        </label>
        <label class="chip">
          <input type="checkbox" formControlName="diabetes" class="checkbox">
          {{ 'conditions.diabetes' | translate }}
        </label>
      </div>
    </div>

    <div class="flex gap-2">
      <button type="button" class="pill-button--white flex-1 text-lg" (click)="cancelEdit()" [disabled]="isSaving()">
        {{ 'common.cancel' | translate }}
      </button>
      <button type="submit" class="pill-button flex-1 text-lg" [disabled]="isSaving() || profileForm.invalid">
        {{ isSaving() ? ('common.saving' | translate) : ('common.save' | translate) }}
      </button>
    </div>
  </form>
</section>

<ng-template #empty>
  <div class="rounded-2xl border border-dashed border-border/70 p-6 text-center text-muted">
    {{ 'patient.noProfileData' | translate }}
  </div>
</ng-template>
